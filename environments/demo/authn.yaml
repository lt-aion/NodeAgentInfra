nameOverride: ""
fullnameOverride: "authn-svc"

replicaCount: 1

serviceAccount:
  create: true

service:
  type: NodePort
  nodePort: 30001

containers:
  - name: postgres
    image:
      repository: postgres
      pullPolicy: IfNotPresent
      tag: "15-alpine"
    ports:
      additional:
        - name: pg
          containerPort: 5432
          protocol: TCP
    env:
      - name: POSTGRES_USER
        value: "postgres"
      - name: POSTGRES_PASSWORD
        value: "postgres"
      - name: POSTGRES_DB
        value: "nodeagent-authn-svc"
      - name: POSTGRES_HOST_AUTH_METHOD
        value: "trust"
    resources:
      limits:
        cpu: 200m
        memory: 256Mi
      requests:
        cpu: 100m
        memory: 128Mi
    volumeMounts:
      - name: dshm
        mountPath: /dev/shm

  - name: main
    image:
      repository: 056562102950.dkr.ecr.ap-south-1.amazonaws.com/aion/nodeagent-authn-svc
      pullPolicy: IfNotPresent
      tag: "latest"
    ports:
      http: 9001
    env:
      - name: ENVIRONMENT
        value: "development"
      - name: SERVER_PORT
        value: "9001"
      - name: DB_CONNECTION
        value: "postgres://postgres:postgres@localhost:5432/nodeagent-authn-svc?sslmode=disable"
      - name: JWT_SECRET
        value: "okiqwheuhwqiuoehiqowh"
      - name: BOOTSTRAP_SECRET
        value: "uiahdqwgheduihqweghuhwqe"
      - name: LOG_LEVEL
        value: "info"
    resources:
      limits:
        cpu: 200m
        memory: 256Mi
      requests:
        cpu: 100m
        memory: 128Mi
    livenessProbe:
      httpGet:
        path: /healthz/live
        port: main-http
    readinessProbe:
      httpGet:
        path: /healthz/ready
        port: main-http
    command: ["/bin/sh", "-c"]
    args:
      - |
        echo "Waiting for Postgres..."
        until nc -z localhost 5432; do sleep 1; done
        echo "Postgres is up! Starting application..."
        /app/nodeagent-authn-svc

volumes:
  - name: dshm
    emptyDir:
      medium: Memory

podDisruptionBudget:
  maxUnavailable: 1
